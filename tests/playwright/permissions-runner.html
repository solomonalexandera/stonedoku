<!doctype html>
<html>
<head><meta charset="utf-8"><title>Permissions Runner</title></head>
<body>
<script type="module">
import '/src/client/entry.js';
import { getAuth, signInAnonymously, signOut as authSignOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import { doc, setDoc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { ref, set as rset, get as rget } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseServices = window.Stonedoku?.firebase || window.firebase;
if (!firebaseServices) {
  throw new Error('Stonedoku entry bootstrap missing in permissions-runner');
}

const app = firebaseServices.app;
const auth = firebaseServices.auth || getAuth(app);
const firestore = firebaseServices.firestore;
const rtdb = firebaseServices.rtdb;

window.testHelpers = {
  signInAnonymously: async () => {
    const res = await signInAnonymously(auth);
    return { uid: res.user.uid };
  },
  signOut: async () => {
    await authSignOut(auth);
    return true;
  },
  writePresenceFor: async (targetUid) => {
    try {
      await rset(ref(rtdb, `presence/${targetUid}`), { status: 'online', displayName: 'X', last_changed: Date.now() });
      return { success: true };
    } catch (e) {
      return { success: false, error: e.message, code: e.code };
    }
  },
  readPresenceAll: async () => {
    try {
      const snap = await rget(ref(rtdb, 'presence'));
      return { success: true, data: snap.val() };
    } catch (e) {
      return { success: false, error: e.message, code: e.code };
    }
  },
  createVanity: async (username) => {
    try {
      const d = doc(firestore, 'vanityLinks', username);
      await setDoc(d, { userId: 'test', username, path: `/profile/${username}` });
      return { success: true };
    } catch (e) {
      return { success: false, error: e.message, code: e.code };
    }
  },
  createUsernameDoc: async (username, userId) => {
    try {
      const d = doc(firestore, 'usernames', username);
      await setDoc(d, { userId });
      return { success: true };
    } catch (e) {
      return { success: false, error: e.message, code: e.code };
    }
  },
  updateUsernameDoc: async (username, newData) => {
    try {
      const d = doc(firestore, 'usernames', username);
      await updateDoc(d, newData);
      return { success: true };
    } catch (e) {
      return { success: false, error: e.message, code: e.code };
    }
  }
};
</script>
Permissions runner loaded.
</body>
</html>
